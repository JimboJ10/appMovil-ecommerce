<app-header 
  [title]="'Configuración'"
  [showBackButton]="true"
  [showCartButton]="false">
</app-header>

<ion-content>
  <div class="contenedor-settings">
    
    <!-- Sección de Perfil -->
    <div class="seccion-perfil">
      <div class="avatar-container">
        <div class="avatar" *ngIf="!usuario?.avatar">
          <span>{{ obtenerIniciales() }}</span>
        </div>
        <img [src]="usuario?.avatar" [alt]="usuario?.name" class="avatar-img" *ngIf="usuario?.avatar" />
      </div>
    </div>

    <!-- Información Personal -->
    <div class="seccion-info">
      <div class="encabezado-seccion">
        <h2>Información Personal</h2>
        <ion-button fill="clear" size="small" (click)="toggleEditarPerfil()">
          <ion-icon [name]="editandoPerfil ? 'close' : 'create'" slot="start"></ion-icon>
          {{ editandoPerfil ? 'Cancelar' : 'Editar' }}
        </ion-button>
      </div>

      <form [formGroup]="formularioPerfil" *ngIf="editandoPerfil">
        <!-- Nombre -->
        <div class="campo-formulario">
          <ion-label position="stacked">Nombre *</ion-label>
          <ion-input
            formControlName="name"
            placeholder="Ingresa tu nombre"
            [class.input-invalido]="campoInvalido('name', 'perfil')">
          </ion-input>
          <div class="mensaje-error" *ngIf="campoInvalido('name', 'perfil')">
            <ion-icon name="alert-circle"></ion-icon>
            <span>{{ obtenerMensajeError('name', 'perfil') }}</span>
          </div>
        </div>

        <!-- Apellido -->
        <div class="campo-formulario">
          <ion-label position="stacked">Apellido *</ion-label>
          <ion-input
            formControlName="surname"
            placeholder="Ingresa tu apellido"
            [class.input-invalido]="campoInvalido('surname', 'perfil')">
          </ion-input>
          <div class="mensaje-error" *ngIf="campoInvalido('surname', 'perfil')">
            <ion-icon name="alert-circle"></ion-icon>
            <span>{{ obtenerMensajeError('surname', 'perfil') }}</span>
          </div>
        </div>

        <!-- Email -->
        <div class="campo-formulario">
          <ion-label position="stacked">Email *</ion-label>
          <ion-input
            formControlName="email"
            type="email"
            placeholder="correo@ejemplo.com"
            [class.input-invalido]="campoInvalido('email', 'perfil')">
          </ion-input>
          <div class="mensaje-error" *ngIf="campoInvalido('email', 'perfil')">
            <ion-icon name="alert-circle"></ion-icon>
            <span>{{ obtenerMensajeError('email', 'perfil') }}</span>
          </div>
        </div>

        <!-- Teléfono -->
        <div class="campo-formulario">
          <ion-label position="stacked">Teléfono</ion-label>
          <ion-input
            formControlName="phone"
            type="tel"
            placeholder="Ingresa tu teléfono">
          </ion-input>
        </div>

        <!-- Fecha de Nacimiento -->
        <div class="campo-formulario">
          <ion-label position="stacked">Fecha de Nacimiento</ion-label>
          <ion-input
            formControlName="birthday"
            type="date">
          </ion-input>
        </div>

        <!-- Botón Guardar -->
        <ion-button expand="block" class="boton-guardar" (click)="guardarPerfil()">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Guardar Cambios
        </ion-button>
      </form>

      <!-- Vista de Solo Lectura -->
      <div class="info-solo-lectura" *ngIf="!editandoPerfil">
        <div class="info-item">
          <ion-icon name="person-outline"></ion-icon>
          <div>
            <span class="etiqueta">Nombre completo</span>
            <span class="valor">{{ usuario?.name }} {{ usuario?.surname }}</span>
          </div>
        </div>

        <div class="info-item">
          <ion-icon name="mail-outline"></ion-icon>
          <div>
            <span class="etiqueta">Email</span>
            <span class="valor">{{ usuario?.email }}</span>
          </div>
        </div>

        <div class="info-item" *ngIf="usuario?.phone">
          <ion-icon name="call-outline"></ion-icon>
          <div>
            <span class="etiqueta">Teléfono</span>
            <span class="valor">{{ usuario?.phone }}</span>
          </div>
        </div>

        <div class="info-item" *ngIf="usuario?.birthday">
          <ion-icon name="calendar-outline"></ion-icon>
          <div>
            <span class="etiqueta">Fecha de nacimiento</span>
            <span class="valor">{{ usuario?.birthday | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Seguridad -->
    <div class="seccion-seguridad">
      <div class="encabezado-seccion">
        <h2>Seguridad</h2>
      </div>

      <!-- Botón para mostrar formulario de cambio de contraseña -->
      <div class="lista-opciones" *ngIf="!mostrarCambioPassword">
        <div class="opcion-item" (click)="toggleCambioPassword()">
          <div class="opcion-info">
            <ion-icon name="key-outline"></ion-icon>
            <span>Cambiar Contraseña</span>
          </div>
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </div>
      </div>

      <!-- FORMULARIO DE CAMBIO DE CONTRASEÑA -->
      <form [formGroup]="formularioPassword" *ngIf="mostrarCambioPassword">
        
        <!-- Contraseña Actual -->
        <div class="campo-formulario">
          <ion-label position="stacked">Contraseña Actual *</ion-label>
          <ion-item 
            lines="none" 
            class="campo-input"
            [class.input-invalido]="campoInvalido('currentPassword', 'password')">
            <ion-icon name="lock-closed-outline" slot="start" class="icono-campo"></ion-icon>
            <ion-input
              id="current-password"
              [type]="mostrarPasswordActual ? 'text' : 'password'"
              formControlName="currentPassword"
              placeholder="Ingresa tu contraseña actual">
            </ion-input>
            <ion-button 
              slot="end" 
              fill="clear" 
              (click)="mostrarPasswordActual = !mostrarPasswordActual">
              <ion-icon [name]="mostrarPasswordActual ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          <div class="mensaje-error" *ngIf="campoInvalido('currentPassword', 'password')">
            <ion-icon name="alert-circle"></ion-icon>
            <span>{{ obtenerMensajeError('currentPassword', 'password') }}</span>
          </div>
        </div>

        <!-- Nueva Contraseña -->
        <div class="campo-formulario">
          <ion-label position="stacked">Nueva Contraseña *</ion-label>
          <ion-item
            lines="none" 
            class="campo-input"
            [class.input-invalido]="campoInvalido('newPassword', 'password')">
            <ion-icon name="lock-closed-outline" slot="start" class="icono-campo"></ion-icon>
            <ion-input
              id="new-password"
              [type]="mostrarPasswordNuevo ? 'text' : 'password'"
              formControlName="newPassword"
              placeholder="Ingresa tu nueva contraseña">
            </ion-input>
            <ion-button 
              slot="end" 
              fill="clear" 
              (click)="mostrarPasswordNuevo = !mostrarPasswordNuevo">
              <ion-icon [name]="mostrarPasswordNuevo ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>

          <!-- Requisitos de contraseña -->
          <div class="requisitos-password" *ngIf="formularioPassword.get('newPassword')?.touched">
            <p class="titulo-requisitos">La contraseña debe contener:</p>
            <div class="requisito" [class.cumplido]="obtenerRequisitosPassword().tieneMayuscula">
              <ion-icon [name]="obtenerRequisitosPassword().tieneMayuscula ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              <span>Una letra mayúscula</span>
            </div>
            <div class="requisito" [class.cumplido]="obtenerRequisitosPassword().tieneMinuscula">
              <ion-icon [name]="obtenerRequisitosPassword().tieneMinuscula ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              <span>Una letra minúscula</span>
            </div>
            <div class="requisito" [class.cumplido]="obtenerRequisitosPassword().tieneNumero">
              <ion-icon [name]="obtenerRequisitosPassword().tieneNumero ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              <span>Un número</span>
            </div>
            <div class="requisito" [class.cumplido]="obtenerRequisitosPassword().tieneCaracterEspecial">
              <ion-icon [name]="obtenerRequisitosPassword().tieneCaracterEspecial ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              <span>Un carácter especial (!@#$...)</span>
            </div>
            <div class="requisito" [class.cumplido]="formularioPassword.get('newPassword')?.value?.length >= 8">
              <ion-icon [name]="formularioPassword.get('newPassword')?.value?.length >= 8 ? 'checkmark-circle' : 'close-circle'"></ion-icon>
              <span>Mínimo 8 caracteres</span>
            </div>
          </div>
        </div>

        <!-- Confirmar Nueva Contraseña -->
        <div class="campo-formulario">
          <ion-label position="stacked">Confirmar Nueva Contraseña *</ion-label>
          <ion-item 
            lines="none" 
            class="campo-input"
            [class.input-invalido]="campoInvalido('confirmPassword', 'password')">
            <ion-icon name="lock-closed-outline" slot="start" class="icono-campo"></ion-icon>
            <ion-input
              id="confirm-password"
              [type]="mostrarPasswordConfirmar ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="Confirma tu nueva contraseña">
            </ion-input>
            <ion-button 
              slot="end" 
              fill="clear" 
              (click)="mostrarPasswordConfirmar = !mostrarPasswordConfirmar">
              <ion-icon [name]="mostrarPasswordConfirmar ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          <div class="mensaje-error" *ngIf="campoInvalido('confirmPassword', 'password')">
            <ion-icon name="alert-circle"></ion-icon>
            <span>{{ obtenerMensajeError('confirmPassword', 'password') }}</span>
          </div>
        </div>

        <!-- Botones -->
        <div class="botones-password">
          <ion-button 
            expand="block" 
            class="boton-guardar" 
            (click)="cambiarPassword()"
            [disabled]="formularioPassword.invalid">
            <ion-icon name="key-outline" slot="start"></ion-icon>
            Cambiar Contraseña
          </ion-button>

          <ion-button 
            expand="block" 
            fill="outline" 
            (click)="toggleCambioPassword()">
            Cancelar
          </ion-button>
        </div>
      </form>
    </div>

    <!-- Opciones Adicionales -->
    <div class="seccion-opciones">
      <h2>Preferencias</h2>
      
      <div class="lista-opciones">
        <div class="opcion-item">
          <div class="opcion-info">
            <ion-icon name="notifications-outline"></ion-icon>
            <span>Notificaciones</span>
          </div>
          <ion-toggle></ion-toggle>
        </div>

        <div class="opcion-item">
          <div class="opcion-info">
            <ion-icon name="mail-outline"></ion-icon>
            <span>Recibir ofertas por email</span>
          </div>
          <ion-toggle></ion-toggle>
        </div>

        <div class="opcion-item" (click)="navegarA('/addresses')">
          <div class="opcion-info">
            <ion-icon name="location-outline"></ion-icon>
            <span>Mis Direcciones</span>
          </div>
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </div>
      </div>
    </div>

    <!-- Sección de Información -->
    <div class="seccion-acerca">
      <h2>Acerca de</h2>
      
      <div class="lista-acerca">
        <div class="item-acerca">
          <span>Versión de la App</span>
          <span>1.0.0</span>
        </div>
        <div class="item-acerca">
          <span>Términos y Condiciones</span>
          <ion-icon name="open-outline"></ion-icon>
        </div>
        <div class="item-acerca">
          <span>Política de Privacidad</span>
          <ion-icon name="open-outline"></ion-icon>
        </div>
      </div>
    </div>
  </div>
</ion-content>